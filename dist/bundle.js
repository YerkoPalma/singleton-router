var UrlPattern=require('url-pattern'),assert=require('assert');function getRouter(a){if(typeof window.RouterInstance!=='undefined'){return window.RouterInstance}window.RouterInstance=new Router(a);return window.RouterInstance}function Router(a){this.routes={};this.currentPath=null;this.previousPath=null;this.currentRoute=null;this.previousRoute=null;this.root=null;this.firstRender=!0;this.rootEl=null;this.store=null;this.default=null;this._debug=!1;this.onRender=a&&a.onRender?a.onRender:null;this.onNavClick=a&&a.onNavClick?a.onNavClick:null;this.prefix=a&&a.prefix?a.prefix:'';var b=this;window.addEventListener('popstate',function(a){b.onPopState(a)});var c=document.querySelectorAll('[data-route]');Array.prototype.forEach.call(c,function(a){a.addEventListener('click',function(b){b.preventDefault();a.setAttribute('data-bind',+new Date);this.goToPath(a.getAttribute('data-route'));typeof this.onNavClick==='function'&&this.onNavClick(a.getAttribute('data-route'),a)})})}Router.prototype.setStore=function(a){this.store=a};Router.prototype.addRoute=function(a,b,c){assert.equal(typeof a,'string');assert.equal(typeof b,'function');assert(typeof c==='undefined'||typeof c==='function');this.routes[a]=new Route(a,b,c)};Router.prototype.setRoot=function(a){a=a||'/';this.root=this.getRoute(a);this.root||(this.addRoute('/',function(){return document.createElement('div')}),this.root=this.routes['/'])};Router.prototype.start=function(a){assert(typeof a==='undefined'||typeof a==='string');assert(Object.keys(this.routes).length>0);assert.notEqual(this.root,null);this.rootEl=document.querySelector(a)||document.body;this.requestStateUpdate()};Router.prototype.onPopState=function(a){a&&a.preventDefault();this.requestStateUpdate(a)};Router.prototype.getRoute=function(a){assert.equal(typeof a,'string');var b=[];for(var c in this.routes)this.routes.hasOwnProperty(c)&&(this.routes[c]._urlPattern.match(a)!==null&&b.push(this.routes[c]));if(b.length===1)return b[0];if(b.length===0)return null};Router.prototype.notFound=function(a){assert.equal(typeof a,'function');this.default=new Route(null,a)};Router.prototype.goToPath=function(a,b){b=b||null;if(a===window.location.pathname){return}this.previousPath=window.location.pathname;this.currentPath=a;this.previousRoute=this.currentRoute||this.root;this.currentRoute=this.getRoute(this.currentPath);window.history.pushState(void 0,b,a);window.requestAnimationFrame(function(){this.manageState()})};Router.prototype.manageState=function(){var a=this;if(this.currentPath===this.previousPath)return;!this.currentRoute&&this.default&&(this.currentRoute=this.default);let b=this.currentRoute.onStart(this.store);if(this.firstRender&&b)this.firstRender=!1,this.rootEl.appendChild(b);else if(!this.onRender||typeof this.onRender!=='function'){let a=this.rootEl.lasttElementChild||this.rootEl.lastChild;this.rootEl.replaceChild(b,a)}else{let a=this.rootEl.lasttElementChild||this.rootEl.lastChild;this.onRender(b,a,this.currentRoute.cb)}var c=document.querySelectorAll('a[data-route]');Array.prototype.forEach.call(c,function(b){b.addEventListener('click',function(c){c.preventDefault();b.getAttribute('data-bind')||a.goToPath(b.getAttribute('data-route'));typeof a.onNavClick==='function'&&a.onNavClick(b.getAttribute('data-route'),b)})});if((!this.onRender||typeof this.onRender!=='function')&&typeof this.currentRoute.cb==='function'){try{this.currentRoute.cb()}catch(a){console.error(a)}}};Router.prototype.requestStateUpdate=function(a){this.previousPath=this.currentPath;this.currentPath=window.location.pathname;this.currentRoute=this.getRoute(a&&a.target!==window?a.target.getAttribute('data-route'):window.location.pathname);window.requestAnimationFrame(function(){this.manageState()})};function Route(a,b,c){this.pattern=a;this.cb=c;this._urlPattern=a?new UrlPattern(a):null;this.view=b;this.params=null;this.path=null}Route.prototype.getParams=function(){if(!this.path)return!1;return this.params};Route.prototype.setParams=function(){if(!this.path)return!1;this.params=this._urlPattern?this._urlPattern.match(this.path):null};Route.prototype.onStart=function(a){this.path=window.location.pathname;this.params=this._urlPattern?this._urlPattern.match(this.path):null;return this.view(this.params,a)};module.exports=getRouter
